# AirSense 硬件连接指南

## ESP32-C5 引脚图

```
                    ESP32-C5
                 ┌─────────────┐
                 │             │
     GPIO0/BOOT  │  1      40  │  GND
           3V3   │  2      39  │  GPIO21 (DART_TX)
           GND   │  3      38  │  GPIO22 (DART_RX)
         GPIO1   │  4      37  │  GPIO23
         GPIO2   │  5      36  │  GPIO24
         GPIO3   │  6      35  │  GPIO25
         GPIO4   │  7      34  │  GPIO26
         GPIO5   │  8      33  │  5V
  I2C_SDA/GPIO6  │  9      32  │  GND
  I2C_SCL/GPIO7  │ 10      31  │  GPIO27
         GPIO8   │ 11      30  │  GPIO28
         GPIO9   │ 12      29  │  GPIO29
        GPIO10   │ 13      28  │  TXD0 (USB)
        GPIO11   │ 14      27  │  RXD0 (USB)
        GPIO12   │ 15      26  │  GPIO30
        GPIO13   │ 16      25  │  GPIO31
        GPIO14   │ 17      24  │  RST
        GPIO15   │ 18      23  │  GND
        GPIO16   │ 19      22  │  3V3
 S8_TX/GPIO17   │ 20      21  │  GPIO18 (S8_RX)
                 └─────────────┘
```

## 传感器连接详情

### 1. SenseAir S8 (CO2传感器)

#### 引脚定义
| S8引脚 | 功能 | 连接到 |
|--------|------|--------|
| VDD | 电源 (+4.5V~5.25V) | 5V |
| GND | 地 | GND |
| RX | UART接收 | ESP32-C5 GPIO17 (TX) |
| TX | UART发送 | ESP32-C5 GPIO18 (RX) |

#### 连接示意图
```
   SenseAir S8                    ESP32-C5
  ┌──────────┐                  ┌──────────┐
  │          │                  │          │
  │  VDD     ├─────────────────►│  5V      │
  │  GND     ├─────────────────►│  GND     │
  │  RX      ├─────────────────►│  GPIO17  │ (UART1_TX)
  │  TX      ├─────────────────►│  GPIO18  │ (UART1_RX)
  │          │                  │          │
  └──────────┘                  └──────────┘
```

#### 注意事项
- S8需要5V供电，功耗约25mA
- UART通信电平为3.3V兼容
- 如果TX/RX连接后无通信，尝试交换连接

---

### 2. SGP41 (VOC/NOx传感器)

#### 引脚定义
| SGP41引脚 | 功能 | 连接到 |
|-----------|------|--------|
| VDD | 电源 (+3.3V) | 3V3 |
| GND | 地 | GND |
| SDA | I2C数据 | ESP32-C5 GPIO6 |
| SCL | I2C时钟 | ESP32-C5 GPIO7 |

#### 连接示意图
```
      SGP41                      ESP32-C5
  ┌──────────┐                  ┌──────────┐
  │          │                  │          │
  │  VDD     ├─────────────────►│  3V3     │
  │  GND     ├─────────────────►│  GND     │
  │  SDA     ├─────────────────►│  GPIO6   │ (I2C_SDA)
  │  SCL     ├─────────────────►│  GPIO7   │ (I2C_SCL)
  │          │                  │          │
  └──────────┘                  └──────────┘
       │                              │
       │  4.7kΩ上拉电阻到3V3          │
```

#### 注意事项
- I2C地址固定为0x59
- SDA和SCL需要上拉电阻 (建议4.7kΩ)
- 预热时间约10秒
- 功耗: 工作48mA，睡眠0.4μA

---

### 3. Dart WZ-H3-N (NH3电化学传感器)

#### 引脚定义
| Dart引脚 | 功能 | 连接到 |
|----------|------|--------|
| VCC | 电源 (+3.3V~5V) | 5V |
| GND | 地 | GND |
| TXD | UART发送 | ESP32-C5 GPIO22 (RX) |
| RXD | UART接收 | ESP32-C5 GPIO21 (TX) |

#### 连接示意图
```
  Dart WZ-H3-N                   ESP32-C5
  ┌──────────┐                  ┌──────────┐
  │          │                  │          │
  │  VCC     ├─────────────────►│  5V      │
  │  GND     ├─────────────────►│  GND     │
  │  TXD     ├─────────────────►│  GPIO22  │ (UART2_RX)
  │  RXD     ├─────────────────►│  GPIO21  │ (UART2_TX)
  │          │                  │          │
  └──────────┘                  └──────────┘
```

#### 工作模式设置
- **问答模式** (默认): MCU发送命令，传感器响应
- **主动上传模式**: 传感器每秒自动上传数据

#### 注意事项
- 电化学传感器需要预热约60秒
- 寿命约2年 (24小时连续工作)
- 功耗: 工作<5mW
- 避免高浓度气体长时间暴露

---

### 4. DPS310 (气压传感器)

#### I2C模式引脚定义
| DPS310引脚 | 功能 | 连接到 |
|------------|------|--------|
| VDD | 电源 (+1.7V~3.6V) | 3V3 |
| GND | 地 | GND |
| SDA | I2C数据 | ESP32-C5 GPIO6 |
| SCL | I2C时钟 | ESP32-C5 GPIO7 |
| SDO | 地址选择 | GND(0x76) 或 3V3(0x77) |
| CSB | 片选 (I2C模式) | 3V3 |

#### I2C连接示意图
```
      DPS310                     ESP32-C5
  ┌──────────┐                  ┌──────────┐
  │          │                  │          │
  │  VDD     ├─────────────────►│  3V3     │
  │  GND     ├─────────────────►│  GND     │
  │  SDA     ├─────────────────►│  GPIO6   │ (I2C_SDA)
  │  SCL     ├─────────────────►│  GPIO7   │ (I2C_SCL)
  │  SDO     ├─────────────────►│  3V3     │ (地址=0x77)
  │  CSB     ├─────────────────►│  3V3     │ (I2C模式)
  │          │                  │          │
  └──────────┘                  └──────────┘
       │                              │
       │  与SGP41共享I2C总线          │
```

#### SPI模式引脚定义 (备选)
| DPS310引脚 | 功能 | 连接到 |
|------------|------|--------|
| VDD | 电源 (+1.7V~3.6V) | 3V3 |
| GND | 地 | GND |
| SDI (MOSI) | SPI数据输入 | ESP32-C5 SPI_MOSI |
| SDO (MISO) | SPI数据输出 | ESP32-C5 SPI_MISO |
| SCK | SPI时钟 | ESP32-C5 SPI_CLK |
| CSB | 片选 | ESP32-C5 GPIO |

#### 注意事项
- I2C地址由SDO引脚电平决定
- 与SGP41共享I2C总线时注意地址冲突
- 功耗: 工作约1.7μA @ 1Hz采样
- 支持中断输出 (可选)

---

## 完整系统连接图

```
                              ESP32-C5
                    ┌──────────────────────┐
                    │                      │
    SenseAir S8 ────┤ GPIO17 (UART1_TX)    │
    (CO2)       ────┤ GPIO18 (UART1_RX)    │
                    │                      │
    Dart WZ-H3-N ───┤ GPIO21 (UART2_TX)    │
    (NH3)       ────┤ GPIO22 (UART2_RX)    │
                    │                      │
    SGP41 ──────────┤ GPIO6  (I2C_SDA)     │
    (VOC/NOx)   ────┤ GPIO7  (I2C_SCL)     │
                    │          │           │
    DPS310 ─────────┤          │           │
    (压力/温度)     │          │           │
                    │                      │
    5V Power ───────┤ 5V                   │
    GND ────────────┤ GND                  │
    USB ────────────┤ USB (编程/调试)      │
                    │                      │
                    └──────────────────────┘
```

## 电源需求

| 组件 | 电压 | 电流 (典型) | 电流 (峰值) |
|------|------|-------------|-------------|
| ESP32-C5 | 3.3V | 80mA | 500mA |
| SenseAir S8 | 5V | 25mA | 35mA |
| SGP41 | 3.3V | 48mA | 48mA |
| Dart WZ-H3-N | 5V | 1mA | 2mA |
| DPS310 | 3.3V | 1.7μA | 800μA |
| **总计** | - | **~155mA** | **~586mA** |

### 电源方案建议

1. **USB供电** (推荐用于验证机)
   - USB提供5V，通过板载LDO转换为3.3V
   - 电流能力: 500mA (足够)

2. **外部电源**
   - 输入: 5V DC，至少1A
   - 使用LDO (如AMS1117-3.3)提供3.3V

3. **电池供电** (未来版本)
   - 3.7V锂电池 + 升压/降压电路
   - 需要实现低功耗模式

## 布线注意事项

### I2C总线
- SDA和SCL走线尽量短，避免长距离走线
- 添加4.7kΩ上拉电阻到3.3V
- 如果总线较长，考虑使用I2C缓冲器

### UART总线
- 注意TX/RX交叉连接
- 如果通信不稳定，添加串联电阻 (22Ω-100Ω)

### 电源
- 每个传感器靠近放置100nF去耦电容
- 电源线和地线尽量粗，降低压降

### 接地
- 所有设备共地
- 避免地环路

## 测试检查清单

- [ ] 电源电压正确 (3.3V和5V)
- [ ] 所有地线连接
- [ ] I2C上拉电阻已添加
- [ ] UART TX/RX连接正确
- [ ] 传感器上电LED指示 (如有)
- [ ] ESP32-C5可以烧录程序
- [ ] 串口监视器可以接收数据
- [ ] 各传感器初始化成功
- [ ] 传感器读数合理

## 故障排除

### 问题1: 传感器无响应
- 检查供电电压和电流
- 用万用表测量传感器引脚电压
- 检查焊接是否良好

### 问题2: I2C通信失败
- 使用I2C扫描程序检测设备地址
- 检查上拉电阻是否安装
- 降低I2C时钟频率

### 问题3: UART数据乱码
- 确认波特率设置正确
- 检查TX/RX是否接反
- 测量UART信号电平

### 问题4: ESP32-C5无法烧录
- 按住BOOT按钮，按RST复位
- 检查USB数据线质量
- 安装CH340或CP2102驱动

## 参考资料

- [ESP32-C5技术规格书](../doc/mcu/)
- [SenseAir S8数据手册](../doc/sensor/)
- [SGP41数据手册](../doc/sensor/)
- [Dart WZ-H3-N数据手册](../doc/sensor/)
- [DPS310数据手册](../doc/sensor/)
